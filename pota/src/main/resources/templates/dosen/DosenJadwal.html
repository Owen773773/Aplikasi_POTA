<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POTA - Jadwal</title>
    <link rel="stylesheet" href="/css/PengajuanBimbingan.css">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>

<div class="main">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo-container">
            <div class="logo-icon-slot">
                <img src="/assets/icons/logo.svg">
            </div>
            <span class="text-navbar">POTA</span>
        </div>

        <nav class="nav-menu">
            <a th:href="@{/dosen/beranda}" class="nav-item">
                <img th:src="@{/assets/icons/ManajemenAkun.svg}" alt="" class="nav-icon"/>
                <span>Beranda</span>
            </a>

            <a th:href="@{/dosen/jadwal}" class="nav-item active">
                <img th:src="@{/assets/icons/Jadwal.svg}" alt="" class="nav-icon"/>
                <span>Jadwal</span>
            </a>

            <a th:href="@{/dosen/bimbingan}" class="nav-item">
                <img th:src="@{/assets/icons/Bimbingan.svg}" alt="" class="nav-icon"/>
                <span>Bimbingan</span>
            </a>

            <a th:href="@{/dosen/notifikasi}" class="nav-item">
                <img th:src="@{/assets/icons/Notifikasi.svg}" alt="" class="nav-icon"/>
                <span>Notifikasi</span>
            </a>

            <a th:href="@{/dosen/profil}" class="nav-item">
                <img th:src="@{/assets/icons/Profil.svg}" alt="" class="nav-icon"/>
                <span>Profil</span>
            </a>

        </nav>

        <div class="logout-section">
            <form th:action="@{/logout}" method="post" style="margin: 0;">
                <button type="submit" class="btn-logout">
                    <img th:src="@{/assets/icons/LogOut.svg}" alt="" />
                    Log Out
                </button>
            </form>
        </div>
    </aside>

    <main class="main-content">
        <div class="content-body">
            <div class="schedule-header">
                <div class="date-display-group" onclick="document.getElementById('week-input').showPicker()">
        <span class="date-display-text">
            <span th:text="${tanggalMulaiMinggu}">24/11/2025</span>
        </span>

                    <input type="week"
                           name="week"
                           th:value="${weekParam}"
                           id="week-input"
                           onchange="submitWeekChange()"
                           class="hidden-functional-input"/>

                    <img th:src="@{/assets/icons/Jadwal.svg}"
                         alt="Pilih Tanggal"
                         class="calendar-icon"
                         onclick="event.stopPropagation(); document.getElementById('week-input').showPicker()"/>
                </div>
            </div>

            <div class="schedule-container">
                <table class="schedule-grid">
                    <thead>
                    <tr>
                        <th class="time-column"></th>
                        <th th:each="entry : ${listHari}" class="day-header">
                            <div class="day-header-content">
                                <div class="day-name"
                                     th:text="${entry.key.getDisplayName(T(java.time.format.TextStyle).FULL, T(java.util.Locale).forLanguageTag('id'))}">
                                    Senin
                                </div>
                                <div class="day-date" th:text="${entry.value}">6/10/2025</div>
                            </div>
                        </th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Loop untuk setiap jam (07.00 - 17.00) -->
                    <tr th:each="hourSlots, iterStat : ${timetable}">
                        <td class="time-column">
                            <span th:text="${#numbers.formatInteger(iterStat.index + 7, 2)} + '.00'">07.00</span>
                        </td>
                        <!-- Loop untuk setiap hari dalam satu jam -->
                        <td th:each="slot : ${hourSlots}"
                            th:class="${'time-slot ' + (slot.status != null ? slot.status : 'available')}"
                            th:data-hour="${slot.jam}"
                            th:data-day="${slot.hari}"
                            th:data-booking-id="${slot.idBooking != null ? slot.idBooking : ''}">
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="schedule-legend">
                <button onclick="showPopup()" class="btn-ajukan-bimbingan">Jadwalkan Bimbingan</button>
                <div class="legend-item"><span class="legend-box status-unavailable"></span> Tidak Tersedia</div>
                <div class="legend-item"><span class="legend-box status-scheduled"></span> Terjadwal</div>
                <div class="legend-item"><span class="legend-box status-pending"></span> Menunggu Konfirmasi</div>
            </div>

            <div id="popup-form" class="popup-overlay hidden">
                <div class="popup-content">
                    <div class="popup-header">
                        <h2 class="popup-title">Pengajuan Bimbingan</h2>
                        <button type="button" class="btn-close" onclick="closePopup()">
                            <span style="font-size: 24px;">&times;</span>
                        </button>
                    </div>
                    <form id="bimbingan-form" class="popup-body" onsubmit="handleSubmit(event)">
                        <div id="form-notification" class="form-notification hidden"></div>

                        <div class="form-group">
                            <label class="form-label">Mahasiswa *</label>

                            <div th:each="mhs, iter : ${listMahasiswa}"
                                 class="input-with-icon"
                                 style="display: flex; align-items: center; margin-bottom: 6px;">

                                <!-- Checkbox -->
                                <input type="checkbox"
                                       style="width: 20px; height: 20px; margin: 0;"
                                       th:id="'mhs_' + ${iter.index}"
                                       th:value="${mhs.idPengguna}"
                                       name="mahasiswaIds"
                                       onchange="checkAvailability()">

                                <!-- Label -->
                                <label th:for="'mhs_' + ${iter.index}"
                                       th:text="${mhs.nama}"
                                       style="padding-left: 12px; margin: 0; cursor: pointer;">
                                </label>

                            </div>
                        </div>

                        <div class="form-group">
                            <label for="tanggal" class="form-label">Tanggal *</label>
                            <div class="input-with-icon" onclick="openDatePicker()">
                                <input type="date"
                                       id="tanggal"
                                       name="tanggal"
                                       class="form-input"
                                       placeholder="Pilih tanggal"
                                       onchange="checkAvailability()"
                                       required/>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Waktu Bimbingan *</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label for="waktuMulai"
                                           style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">
                                        Jam Mulai
                                    </label>
                                    <div class="input-with-icon">
                                        <select id="waktuMulai" name="waktuMulai" class="form-input" required>
                                            <option value="" disabled selected>Pilih jam mulai</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label for="waktuSelesai"
                                           style="font-size: 12px; color: #666; margin-bottom: 4px; display: block;">
                                        Jam Selesai
                                    </label>
                                    <div class="input-with-icon">
                                        <select id="waktuSelesai" name="waktuSelesai" class="form-input" required disabled>
                                            <option value="" disabled selected>Pilih jam selesai</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="ruangan" class="form-label">Ruangan *</label>
                            <div class="input-with-icon">
                                <select id="ruangan" name="ruangan" class="form-input" required>
                                    <option value="" disabled selected>Pilih ruangan</option>
                                    <option th:each="ruang : ${listRuangan}"
                                            th:value="${ruang.idRuangan}"
                                            th:text="${ruang.namaRuangan}">
                                        Ruang 101
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="jumlahMinggu" class="form-label">Pengulangan Mingguan (Opsional)</label>
                            <div class="input-with-icon">
                                <input type="number"
                                       id="jumlahMinggu"
                                       name="jumlahMinggu"
                                       class="form-input"
                                       placeholder="0 = Tidak ada pengulangan"
                                       min="0"
                                       max="4"
                                       value="0"
                                       style="width: 100%;"/>
                            </div>
                            <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
                                1 = Bimbingan tiap minggu berturut-turut dengan hari dan jam yang sama. 0 = hanya sekali.
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="topik" class="form-label">Topik Bimbingan *</label>
                            <input type="text"
                                   id="topik"
                                   name="topik"
                                   class="form-input"
                                   placeholder="Masukkan topik bimbingan"
                                   required/>
                        </div>

                        <div class="form-group">
                            <label for="deskripsi" class="form-label">Deskripsi Topik (Opsional)</label>
                            <textarea id="deskripsi"
                                      name="deskripsi"
                                      class="form-input"
                                      rows="4"
                                      placeholder="Masukkan deskripsi topik"
                                      style="resize: none"></textarea>
                        </div>

                        <div class="form-actions"
                             style="padding: 20px 0 0 0; border-top: 1px solid var(--border-light); display: flex; justify-content: center;">
                            <button type="submit" class="btn-submit primary" style="width: 100%; max-width: 300px;">
                                Kirim Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    let availableSlots = [];

    function showNotification(message, isError = true) {
        const notification = document.getElementById('form-notification');
        if (notification) {
            notification.textContent = message;
            notification.classList.remove('hidden');
            notification.style.backgroundColor = isError ? '#fee' : '#efe';
            notification.style.color = isError ? '#c33' : '#3c3';
            notification.style.border = isError ? '1px solid #fcc' : '1px solid #cfc';
            notification.style.padding = '12px';
            notification.style.borderRadius = '8px';
            notification.style.marginBottom = '16px';

            setTimeout(() => {
                notification.classList.add('hidden');
            }, 5000);
        }
    }

    function hideNotification() {
        const notification = document.getElementById('form-notification');
        if (notification) {
            notification.classList.add('hidden');
        }
    }

    function showPopup() {
        document.getElementById('popup-form').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closePopup() {
        document.getElementById('popup-form').classList.add('hidden');
        document.body.style.overflow = '';
        hideNotification();

        // Reset form dengan benar
        const form = document.getElementById('bimbingan-form');
        if (form) {
            form.reset();
        }
        availableSlots = [];
        document.getElementById('waktuSelesai').disabled = true;
    }

    // Close popup when clicking outside
    document.getElementById('popup-form').addEventListener('click', function (e) {
        if (e.target === this) {
            closePopup();
        }
    });

    // Close popup with ESC key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closePopup();
        }
    });

    function handleSubmit(event) {
        event.preventDefault();
        hideNotification();

        const mahasiswaCheckboxes = document.querySelectorAll('input[name="mahasiswaIds"]');
        let mahasiswaSelected = false;

        mahasiswaCheckboxes.forEach(cb => {
            if (cb.checked) mahasiswaSelected = true;
        });

        if (!mahasiswaSelected) {
            showNotification("Pilih minimal satu mahasiswa.", true);
            return false;
        }

        const tanggal = document.getElementById('tanggal').value.trim();
        const waktuMulai = document.getElementById('waktuMulai').value.trim();
        const waktuSelesai = document.getElementById('waktuSelesai').value.trim();
        const ruangan = document.getElementById('ruangan').value.trim();
        const topik = document.getElementById('topik').value.trim();
        const jumlahMinggu = document.getElementById('jumlahMinggu').value.trim();

        const missingFields = [];

        if (!tanggal) missingFields.push('Tanggal');
        if (!waktuMulai) missingFields.push('Waktu Mulai');
        if (!waktuSelesai) missingFields.push('Waktu Selesai');
        if (!ruangan) missingFields.push('Ruangan');
        if (!topik) missingFields.push('Topik Bimbingan');

        if (missingFields.length > 0) {
            const message = `Mohon isi semua field yang wajib: ${missingFields.join(', ')}`;
            showNotification(message, true);
            return false;
        }

        const mahasiswaIds = [...mahasiswaCheckboxes]
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        const formData = {
            mahasiswaIds: mahasiswaIds,
            tanggal: tanggal,
            waktuMulai: waktuMulai,
            waktuSelesai: waktuSelesai,
            idRuangan: parseInt(ruangan),
            topik: topik,
            deskripsi: document.getElementById('deskripsi').value.trim(),
            jumlahMinggu: parseInt(jumlahMinggu) || 0
        };

        console.log('Mengirim data:', formData);

        // Disable button saat mengirim
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Mengirim...';

        fetch('/dosen/ajukan-bimbingan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(response => {
                if (response.success) {
                    alert(response.message || 'Pengajuan bimbingan berhasil!');
                    closePopup();
                    location.reload();
                } else {
                    showNotification(response.message || 'Gagal mengirim request', true);
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            })
            .catch(err => {
                console.error('Error:', err);
                showNotification('Gagal mengirim request. Silakan coba lagi.', true);
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });

        return false;
    }

    function checkAvailability() {
        const tanggal = document.getElementById('tanggal').value;
        const waktuMulaiSelect = document.getElementById('waktuMulai');
        const waktuSelesaiSelect = document.getElementById('waktuSelesai');

        // Ambil semua checkbox mahasiswa
        const mahasiswaCheckboxes = document.querySelectorAll('input[name="mahasiswaIds"]');
        const selectedMahasiswa = [...mahasiswaCheckboxes]
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        // Jika tidak pilih mahasiswa atau tanggal belum dipilih
        if (selectedMahasiswa.length === 0 || !tanggal) {
            waktuMulaiSelect.innerHTML = '<option value="" disabled selected>Pilih jam mulai</option>';
            waktuSelesaiSelect.innerHTML = '<option value="" disabled selected>Pilih jam selesai</option>';
            waktuSelesaiSelect.disabled = true;
            availableSlots = [];
            return;
        }

        // Tampilkan loading
        waktuMulaiSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';
        waktuSelesaiSelect.innerHTML = '<option value="" disabled selected>Pilih jam selesai</option>';
        waktuSelesaiSelect.disabled = true;

        // Build URL: ?idMhs=a&idMhs=b&idMhs=c
        let url = `/dosen/cek-slot-tersedia?tanggal=${tanggal}`;
        selectedMahasiswa.forEach(id => {
            url += `&idMhs=${encodeURIComponent(id)}`;
        });

        fetch(url)
            .then(response => response.json())
            .then(data => {
                data.sort();
                availableSlots = data;

                waktuMulaiSelect.innerHTML = '<option value="" disabled selected>Pilih jam mulai</option>';
                waktuSelesaiSelect.innerHTML = '<option value="" disabled selected>Pilih jam selesai</option>';
                waktuSelesaiSelect.disabled = true;

                if (data.length === 0) {
                    waktuMulaiSelect.innerHTML = '<option value="" disabled>Jadwal Bentrok / Penuh</option>';
                    showNotification('Tidak ada slot waktu yang tersedia untuk mahasiswa yang dipilih', true);
                } else {
                    data.forEach(w => {
                        const option = document.createElement('option');
                        option.value = w;
                        option.text = w;
                        waktuMulaiSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                waktuMulaiSelect.innerHTML = '<option value="" disabled>Error loading slots</option>';
                showNotification('Gagal memuat slot waktu.', true);
            });
    }

    function updateWaktuSelesai() {
        const waktuMulaiSelect = document.getElementById('waktuMulai');
        const waktuSelesaiSelect = document.getElementById('waktuSelesai');
        const selectedStartTime = waktuMulaiSelect.value;

        waktuSelesaiSelect.innerHTML = '<option value="" disabled selected>Pilih jam selesai</option>';
        waktuSelesaiSelect.disabled = true;

        if (!selectedStartTime) return;

        const startIndex = availableSlots.indexOf(selectedStartTime);
        if (startIndex === -1) return;

        const startHour = parseInt(selectedStartTime.split(":")[0]);

        let clusterSize = 1;
        let lastHour = startHour;

        for (let i = startIndex + 1; i < availableSlots.length; i++) {
            const slotHour = parseInt(availableSlots[i].split(":")[0]);
            if (slotHour === lastHour + 1) {
                clusterSize++;
                lastHour = slotHour;
            } else {
                break;
            }
        }

        const maxEndHour = startHour + clusterSize;

        for (let h = startHour + 1; h <= maxEndHour; h++) {
            const jamStr = (h < 10 ? "0" + h : h) + ":00";
            const option = document.createElement('option');
            option.value = jamStr;
            option.text = jamStr;
            waktuSelesaiSelect.appendChild(option);
        }

        waktuSelesaiSelect.disabled = false;
    }

    function submitWeekChange() {
        const weekInput = document.getElementById('week-input');
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('week', weekInput.value);
        window.location.href = currentUrl.toString();
    }

    function openDatePicker() {
        const dateInput = document.getElementById('tanggal');
        if (dateInput) {
            dateInput.showPicker();
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function () {
        const waktuMulaiInput = document.getElementById('waktuMulai');

        if (waktuMulaiInput) {
            waktuMulaiInput.addEventListener('change', updateWaktuSelesai);
        }

        // Hide notification on input
        const formInputs = ['tanggal', 'waktuMulai', 'waktuSelesai', 'ruangan', 'topik', 'deskripsi', 'jumlahMinggu'];
        formInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('input', hideNotification);
                input.addEventListener('change', hideNotification);
            }
        });
    });
</script>

</body>

</html>