<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POTA - Akun</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="main">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo-container">
            <img th:src="@{/assets/icons/logo.svg}" alt="Logo POTA" class="logo-icon" />
            <span class="logo-text">POTA</span>
        </div>
        <nav class="nav-menu">
            <a th:href="@{/admin/akun}" class="nav-item active">
                <img th:src="@{/assets/icons/ManajemenAkun.svg}" alt="" class="nav-icon" />
                <span>Akun</span>
            </a>
            <a th:href="@{/admin/ruangan}" class="nav-item">
                <img th:src="@{/assets/icons/Jadwal.svg}" alt="" class="nav-icon" />
                <span>Ruangan</span>
            </a>
            <a th:href="@{/admin/pengaturan}" class="nav-item">
                <img th:src="@{/assets/icons/Setting.svg}" alt="" class="nav-icon" />
                <span>Pengaturan</span>
            </a>
        </nav>
        <div class="logout-section">
            <form th:action="@{/logout}" method="post" style="margin: 0;">
                <button type="submit" class="btn-logout">
                    <img th:src="@{/assets/icons/LogOut.svg}" alt="" />
                    Log Out
                </button>
            </form>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header>
            <h1 class="page-title">Akun</h1>
        </header>
        <div class="content-body">
            <!-- Toolbar -->
            <div class="toolbar">
                <div class="search-bar">
                    <img th:src="@{/assets/icons/SearchBar.svg}" alt="" class="search-icon" />
                    <input type="text" placeholder="Masukkan nama pengguna" />
                </div>
                <div class="toolbar-actions">
                    <button type="button" class="btn-toolbar add" title="Tambah Akun" onclick="showPopup('popup-upload-excel')">
                        <img th:src="@{/assets/icons/plus.svg}" alt="Tambah" />
                    </button>
                    <button type="button" class="btn-toolbar filter" title="Filter">
                        <img th:src="@{/assets/icons/filter.svg}" alt="Filter" />
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                    <tr>
                        <th style="width: 50px" class="text-center">No</th>
                        <th>Nama</th>
                        <th class="text-center">Tipe Akun</th>
                        <th class="text-center">Terakhir Masuk</th>
                        <th style="width: 150px">Aksi</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="user, iterStat : ${listUser}">
                        <td class="text-center" th:text="${iterStat.count}">1</td>
                        <td class="text-bold color-primary" th:text="${user.nama}">Nama Pengguna</td>
                        <td class="text-bold color-primary" th:text="${user.tipeAkun}">Mahasiswa</td>
                        <td class="text-bold color-primary"
                            th:text="${user.lastLogin != null ? #temporals.format(user.lastLogin, 'dd/M/yyyy HH:mm') : '-'}">
                            -
                        </td>
                        <td class="table-actions">
                            <!-- Toggle Status Button -->
                            <a th:href="@{/admin/toggleStatus(idPengguna=${user.idPengguna})}"
                               th:class="'btn-action ' + (${user.statusAktif} ? 'blue' : 'grey')"
                               th:title="${user.statusAktif} ? 'Nonaktifkan Akun' : 'Aktifkan Akun'"
                               onclick="return confirm('Apakah Anda yakin ingin mengubah status pengguna ini?')">
                                <img th:if="${user.statusAktif}"
                                     th:src="@{/assets/icons/enable.svg}"
                                     alt="Aktif" />
                                <img th:unless="${user.statusAktif}"
                                     th:src="@{/assets/icons/disable.svg}"
                                     alt="Nonaktif" />
                            </a>
                            <!-- Delete Button -->
                            <a th:href="@{/admin/delete/{id}(id=${user.idPengguna})}"
                               class="btn-action red"
                               title="Hapus"
                               onclick="return confirm('Yakin ingin menghapus?')">
                                <img th:src="@{/assets/icons/delete.svg}" alt="Hapus" />
                            </a>
                            <!-- Edit Button -->
                            <button type="button"
                                    class="btn-action green"
                                    title="Edit"
                                    th:attr="data-user-id=${user.idPengguna}, data-tipe-akun=${user.tipeAkun}"
                                    onclick="showDetailPopup(this.getAttribute('data-user-id'), this.getAttribute('data-tipe-akun'))">
                                <img th:src="@{/assets/icons/edit.svg}" alt="Edit" />
                            </button>
                        </td>
                    </tr>
                    <!-- Empty State -->
                    <tr th:if="${#lists.isEmpty(listUser)}">
                        <td colspan="5" class="empty-state">
                            Tidak ada data pengguna ditemukan.
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Popup Upload Excel -->
        <div id="popup-upload-excel" class="popup-overlay hidden">
            <div class="popup-content">
                <div class="popup-header">
                    <h3 class="popup-title">Upload File Excel</h3>
                    <button type="button" class="btn-close" onclick="hidePopup('popup-upload-excel')" title="Tutup">
                        <img th:src="@{/assets/icons/x.svg}" alt="Tutup" />
                    </button>
                </div>
                <div class="popup-body">
                    <form th:action="@{/user/upload-excel}" method="post" enctype="multipart/form-data" class="popup-form">
                        <p class="form-text">
                            Unduh template Excel untuk memastikan format data yang benar.
                        </p>
                        <a th:href="@{/assets/template/user_template.xlsx}" class="btn-download" download>
                            Unduh Template
                        </a>
                        <hr class="form-divider" />
                        <div class="form-group">
                            <label for="file" class="form-label">Pilih File Excel (.xlsx):</label>
                            <input type="file" id="file" name="file" class="form-input" accept=".xlsx" required />
                        </div>
                        <button type="submit" class="btn-submit primary">Upload dan Proses</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Popup Detail/Edit Akun -->
        <div id="popup-detail-akun" class="popup-overlay hidden">
            <div class="popup-content popup-wide">
                <div class="popup-header">
                    <h3 class="popup-title">Detail Akun</h3>
                    <button type="button" class="btn-back" onclick="hidePopup('popup-detail-akun')">
                        <img th:src="@{/assets/icons/xHitam.svg}" alt="Kembali"/>
                    </button>
                </div>
                <div class="popup-body">
                    <!-- Form Data Pengguna -->
                    <form id="form-user" th:action="@{/user/update}" method="post">
                        <input type="hidden" id="user-idPengguna" name="idPengguna" />
                        <div class="form-grid">
                            <label for="user-nama">Nama</label>
                            <input type="text" id="user-nama" name="nama" class="form-input" required />

                            <label for="user-tipeAkun">Tipe Akun</label>
                            <select id="user-tipeAkun" name="tipeAkun" class="form-input" onchange="toggleSectionByTipeAkun(this.value)">
                                <option value="Mahasiswa">Mahasiswa</option>
                                <option value="Dosen">Dosen</option>
                                <option value="Admin">Admin</option>
                            </select>

                            <label for="user-username">Username</label>
                            <input type="text" id="user-username" name="username" class="form-input" required />

                            <label for="user-password">Password</label>
                            <input type="password" id="user-password" name="password" placeholder="Kosongkan jika tidak ingin mengubah" class="form-input" />
                        </div>
                        <button type="submit" class="btn-submit" style="justify-self: flex-end; margin-top: 20px;">Simpan Data Pengguna</button>
                    </form>

                    <!-- Section untuk Mahasiswa - TA -->
                    <div id="section-mahasiswa" class="ta-section" style="display: none; margin-top: 30px; border-top: 2px solid #ddd; padding-top: 20px;">
                        <h4 style="margin-bottom: 15px;">Data Tugas Akhir</h4>
                        <div class="tab-buttons">
                            <button type="button" class="tab-btn active" onclick="switchTaTab('ta1', this)">TA1</button>
                            <button type="button" class="tab-btn" onclick="switchTaTab('ta2', this)">TA2</button>
                        </div>
                        <form id="form-ta" th:action="@{/user/update-ta}" method="post">
                            <input type="hidden" id="ta-idPengguna" name="idPengguna" />

                            <!-- Tab TA1 -->
                            <div id="ta1" class="tab-pane active">
                                <div class="form-grid">
                                    <label for="topikTa1">Topik TA1</label>
                                    <input type="text" id="topikTa1" name="topikTa1" class="form-input" />

                                    <label for="jumlahBimbinganTa1">Jumlah Bimbingan</label>
                                    <input type="number" id="jumlahBimbinganTa1" name="jumlahBimbinganTa1" class="form-input" readonly />

                                    <label for="pembimbing1Ta1">Pembimbing 1</label>
                                    <input type="text" id="pembimbing1Ta1" name="pembimbing1Ta1" class="form-input" placeholder="Nama Dosen" />

                                    <label for="pembimbing2Ta1">Pembimbing 2</label>
                                    <input type="text" id="pembimbing2Ta1" name="pembimbing2Ta1" class="form-input" placeholder="Nama Dosen" />
                                </div>
                            </div>

                            <!-- Tab TA2 -->
                            <div id="ta2" class="tab-pane hidden">
                                <div class="form-grid">
                                    <label for="topikTa2">Topik TA2</label>
                                    <input type="text" id="topikTa2" name="topikTa2" class="form-input" />

                                    <label for="jumlahBimbinganTa2">Jumlah Bimbingan</label>
                                    <input type="number" id="jumlahBimbinganTa2" name="jumlahBimbinganTa2" class="form-input" readonly />

                                    <label for="pembimbing1Ta2">Pembimbing 1</label>
                                    <input type="text" id="pembimbing1Ta2" name="pembimbing1Ta2" class="form-input" placeholder="Nama Dosen" />

                                    <label for="pembimbing2Ta2">Pembimbing 2</label>
                                    <input type="text" id="pembimbing2Ta2" name="pembimbing2Ta2" class="form-input" placeholder="Nama Dosen" />
                                </div>
                            </div>
                            <button type="submit" class="btn-submit" style="margin-top: 20px;">Simpan Data TA</button>
                        </form>
                    </div>

                    <!-- Section untuk Dosen - Topik Bimbingan -->
                    <div id="section-dosen" class="dosen-section" style="display: none; margin-top: 30px; border-top: 2px solid #ddd; padding-top: 20px;">
                        <h4 style="margin-bottom: 15px;">Topik Bimbingan</h4>
                        <form id="form-dosen" th:action="@{/dosen/update-topik}" method="post">
                            <input type="hidden" id="dosen-idPengguna" name="idPengguna" />
                            <div class="form-grid">
                                <label for="topikBimbingan">Pilih Topik Bimbingan</label>
                                <select id="topikBimbingan" name="topikBimbingan" class="form-input" multiple size="5">
                                    <option value="Artificial Intelligence">Artificial Intelligence</option>
                                    <option value="Machine Learning">Machine Learning</option>
                                    <option value="Data Science">Data Science</option>
                                    <option value="Web Development">Web Development</option>
                                    <option value="Mobile Development">Mobile Development</option>
                                    <option value="Database Management">Database Management</option>
                                    <option value="Cyber Security">Cyber Security</option>
                                    <option value="Cloud Computing">Cloud Computing</option>
                                    <option value="IoT">Internet of Things (IoT)</option>
                                    <option value="Blockchain">Blockchain</option>
                                </select>
                                <small style="color: #666; grid-column: span 2;">Tekan Ctrl (atau Cmd di Mac) untuk memilih lebih dari satu topik</small>
                            </div>
                            <button type="submit" class="btn-submit" style="margin-top: 20px;">Simpan Topik Bimbingan</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    // Generic Popup Controls
    function showPopup(popupId) {
        const popup = document.getElementById(popupId);
        if (popup) {
            popup.classList.remove('hidden');
        }
    }

    function hidePopup(popupId) {
        const popup = document.getElementById(popupId);
        if (popup) {
            popup.classList.add('hidden');
        }
    }

    // Show Detail Popup with User Type Detection
    function showDetailPopup(userId, tipeAkun) {
        console.log('Opening detail popup for user:', userId, 'Type:', tipeAkun);

        // Fetch user data via AJAX
        fetch('/admin/getUser?idPengguna=' + userId)
            .then(response => response.json())
            .then(data => {
                // Populate basic user data
                document.getElementById('user-idPengguna').value = data.idPengguna;
                document.getElementById('user-nama').value = data.nama;
                document.getElementById('user-tipeAkun').value = data.tipeAkun;
                document.getElementById('user-username').value = data.username;
                document.getElementById('user-password').value = '';

                // Show appropriate section based on user type
                toggleSectionByTipeAkun(data.tipeAkun);

                // If Mahasiswa, load TA data
                if (data.tipeAkun === 'Mahasiswa') {
                    loadTAData(userId);
                }

                // If Dosen, load topik bimbingan
                if (data.tipeAkun === 'Dosen') {
                    loadTopikBimbingan(userId);
                }
            })
            .catch(error => {
                console.error('Error loading user data:', error);
                alert('Gagal memuat data pengguna');
            });

        showPopup('popup-detail-akun');
    }

    // Toggle section visibility based on user type
    function toggleSectionByTipeAkun(tipeAkun) {
        const sectionMahasiswa = document.getElementById('section-mahasiswa');
        const sectionDosen = document.getElementById('section-dosen');

        // Hide all sections first
        sectionMahasiswa.style.display = 'none';
        sectionDosen.style.display = 'none';

        // Show appropriate section
        if (tipeAkun === 'Mahasiswa') {
            sectionMahasiswa.style.display = 'block';
        } else if (tipeAkun === 'Dosen') {
            sectionDosen.style.display = 'block';
        }
    }

    // Load TA data for Mahasiswa
    function loadTAData(userId) {
        fetch('/admin/getTAData?idPengguna=' + userId)
            .then(response => response.json())
            .then(data => {
                document.getElementById('ta-idPengguna').value = userId;

                // TA1 data
                document.getElementById('topikTa1').value = data.topikTa1 || '';
                document.getElementById('jumlahBimbinganTa1').value = data.jumlahBimbinganTa1 || 0;
                document.getElementById('pembimbing1Ta1').value = data.pembimbing1Ta1 || '';
                document.getElementById('pembimbing2Ta1').value = data.pembimbing2Ta1 || '';

                // TA2 data
                document.getElementById('topikTa2').value = data.topikTa2 || '';
                document.getElementById('jumlahBimbinganTa2').value = data.jumlahBimbinganTa2 || 0;
                document.getElementById('pembimbing1Ta2').value = data.pembimbing1Ta2 || '';
                document.getElementById('pembimbing2Ta2').value = data.pembimbing2Ta2 || '';
            })
            .catch(error => {
                console.error('Error loading TA data:', error);
            });
    }

    // Load topik bimbingan for Dosen
    function loadTopikBimbingan(userId) {
        fetch('/admin/getTopikBimbingan?idPengguna=' + userId)
            .then(response => response.json())
            .then(data => {
                document.getElementById('dosen-idPengguna').value = userId;

                const selectElement = document.getElementById('topikBimbingan');
                // Clear previous selections
                Array.from(selectElement.options).forEach(option => {
                    option.selected = false;
                });

                // Select topics from data
                if (data.topikBimbingan && Array.isArray(data.topikBimbingan)) {
                    data.topikBimbingan.forEach(topik => {
                        Array.from(selectElement.options).forEach(option => {
                            if (option.value === topik) {
                                option.selected = true;
                            }
                        });
                    });
                }
            })
            .catch(error => {
                console.error('Error loading topik bimbingan:', error);
            });
    }

    // Switch TA Tab
    function switchTaTab(tabId, buttonElement) {
        // Hide all tab panes
        document.querySelectorAll('.ta-section .tab-pane').forEach(pane => {
            pane.classList.add('hidden');
            pane.classList.remove('active');
        });

        // Show selected tab
        const selectedTab = document.getElementById(tabId);
        if (selectedTab) {
            selectedTab.classList.remove('hidden');
            selectedTab.classList.add('active');
        }

        // Update button active state
        document.querySelectorAll('.ta-section .tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        if (buttonElement) {
            buttonElement.classList.add('active');
        }
    }

    // Close popup when clicking outside
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.popup-overlay').forEach(popup => {
            popup.addEventListener('click', function(e) {
                if (e.target === this) {
                    hidePopup(this.id);
                }
            });
        });

        // Close popup on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.popup-overlay:not(.hidden)').forEach(popup => {
                    hidePopup(popup.id);
                });
            }
        });
    });
</script>
</body>
</html>