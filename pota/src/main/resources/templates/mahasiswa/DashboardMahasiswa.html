<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POTA - Beranda</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/mahasiswa.css">
    <link rel="stylesheet" href="/css/StylePopup.css">
</head>

<body>

<div class="main">
    <aside class="sidebar">
        <div class="logo-container">
            <img src="/assets/icons/logo.svg">
            <span class="text-navbar">POTA</span>
        </div>

        <nav class="nav-menu">
            <a th:href="@{/mahasiswa/beranda}" class="nav-item active">
                <img th:src="@{/assets/icons/ManajemenAkun.svg}" alt="" class="nav-icon"/>
                <span>Beranda</span>
            </a>

            <a th:href="@{/mahasiswa/jadwal}" class="nav-item">
                <img th:src="@{/assets/icons/Jadwal.svg}" alt="" class="nav-icon"/>
                <span>Jadwal</span>
            </a>

            <a th:href="@{/mahasiswa/bimbingan}" class="nav-item">
                <img th:src="@{/assets/icons/Bimbingan.svg}" alt="" class="nav-icon"/>
                <span>Bimbingan</span>
            </a>

            <a th:href="@{/mahasiswa/notifikasi}" class="nav-item">
                <img th:src="@{/assets/icons/Notifikasi.svg}" alt="" class="nav-icon"/>
                <span>Notifikasi</span>
            </a>

            <a th:href="@{/mahasiswa/profil}" class="nav-item">
                <img th:src="@{/assets/icons/Profil.svg}" alt="" class="nav-icon"/>
                <span>Profil</span>
            </a>

        </nav>

        <div class="logout-section">
            <form th:action="@{/logout}" method="post" style="margin: 0;">
                <button type="submit" class="btn-logout">
                    <img th:src="@{/assets/icons/LogOut.svg}" alt=""/>
                    Log Out
                </button>
            </form>
        </div>
    </aside>

    <main class="main-content">
        <header>
            <h1 class="page-title">Beranda</h1>
        </header>

        <div class="content-body">

            <section class="card card-full">
                <h2>Progress Bimbingan</h2>

                <div class="ringkasan-grid" th:object="${DashboardDataMhs}">
                    <div class="ringkasan-info">
                        <p>Semester Aktif : <b><span th:text="*{semesterAktif}">Semester Aktif</span></b></p>
                        <p>Tahap Skripsi : <b><span th:text="*{tahapSkripsi}">tahap</span></b><p>
                        <p>Judul Skripsi : <b><span th:text="*{judulSkripsi}">judul</span></b></p>
                        <p>Dosen Pembimbing 1 : <b><span th:text="*{dosenPembimbing1}"> </span></b></p>
                        <p>Dosen Pembimbing 2 : <b><span th:text="*{dosenPembimbing2}"> </span></b></p>
                    </div>

                    <div class="target-box">
                        <h3>Sesi Pra - UTS</h3>
                        <div class="target-number" th:text="*{sesiPraUTS}"> </div>
                        <p>Total Sesi</p>
                        <span>Target:<span th:text="*{targetPraUTS}"></span> </span>
                    </div>

                    <div class="target-box">
                        <h3>Sesi Pasca - UTS</h3>
                        <div class="target-number" th:text="*{sesiPascaUTS}"></div>
                        <p>Total Sesi</p>
                        <span>Target: <span th:text="*{targetPascaUTS}"></span>
                    </div>
                </div>
            </section>

            <section class="card card-full">
                <div id="header-bottom">
                    <h2>Bimbingan Mendatang</h2>
                </div>

                <div class="bottom-grid" th:if="${bimbinganMendatang != null}">
                    <div class="bottom-info">
                        <div class="info-row">
                            <span class="info-label">Tanggal</span>
                            <span class="info-separator">:</span>
                            <span class="info-value" th:text="${bimbinganMendatang.tanggal}">tgl</span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Jam</span>
                            <span class="info-separator">:</span>
                            <span class="info-value" th:text="${bimbinganMendatang.jam}">jam</span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Durasi</span>
                            <span class="info-separator">:</span>
                            <span class="info-value" th:text="${bimbinganMendatang.durasi}"> Jam</span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Lokasi</span>
                            <span class="info-separator">:</span>
                            <span class="info-value" th:text="${bimbinganMendatang.namaLokasi}">lokasi</span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Dosen</span>
                            <span class="info-separator">:</span>
                            <span class="info-value" th:text="${bimbinganMendatang.dosenLengkap}">dosen</span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Mahasiswa</span>
                            <span class="info-separator">:</span>
                            <span class="info-value" th:text="${bimbinganMendatang.mahasiswa.isEmpty() ? '-' : #strings.listJoin(bimbinganMendatang.mahasiswa, ', ')}">-</span>
                        </div>
                    </div>

                    <div class="bottom-right">
                        <textarea placeholder="Catatan:" th:text="${bimbinganMendatang.deskripsi}"></textarea>

                        <div class="bottom-buttons">
                            <button class="btn-grey"
                                    onclick="validasiBimbingan(this)"
                                    th:attr="data-id-bim=${bimbinganMendatang.idBimbingan}">
                                VALIDASI
                            </button>
                            <button class="btn-red"
                                    onclick="showPopupBatal(this)"
                                    th:attr="data-id-bim=${bimbinganMendatang.idBimbingan}">
                                Batalkan Bimbingan
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bottom-grid" th:if="${bimbinganMendatang == null}">
                    <p style="text-align: center; padding: 20px; color: #666;">
                        Tidak ada bimbingan mendatang yang terjadwalkan.
                    </p>
                </div>
            </section>

        </div>
    </main>
</div>

<div id="popupBatal" class="popup-overlay">
    <div class="popup-container">
        <div class="popup-header">
            <h1 class="popup-title">Alasan Pembatalan</h1>
            <button class="popup-close" onclick="closePopup('popupBatal')">&times;</button>
        </div>
        <div class="popup-content">
            <textarea id="alasanBatal" class="popup-textarea large"
                      placeholder="Masukkan alasan pembatalan (wajib)..."></textarea>
        </div>
        <div class="popup-footer">
            <button class="popup-btn btn-secondary" onclick="closePopup('popupBatal')">Batal</button>
            <button class="popup-btn btn-danger" onclick="submitPembatalan()">Batalkan</button>
        </div>
    </div>
</div>

<script>
    let currentIdBim = null;

    function validasiBimbingan(button) {
        const idBim = button.getAttribute('data-id-bim');

        if (!confirm('Apakah Anda yakin ingin memvalidasi bimbingan ini?')) {
            return;
        }

        fetch('/mahasiswa/bimbingan/validasi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `idBim=${idBim}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat memproses permintaan.');
            });
    }

    function showPopupBatal(button) {
        currentIdBim = button.getAttribute('data-id-bim');
        document.getElementById('alasanBatal').value = '';
        document.getElementById('popupBatal').classList.add('active');
    }

    function closePopup(popupId) {
        document.getElementById(popupId).classList.remove('active');
        currentIdBim = null;
    }

    function submitPembatalan() {
        const catatan = document.getElementById('alasanBatal').value;

        if (!currentIdBim) {
            alert('ID Bimbingan tidak ditemukan!');
            return;
        }

        if (!catatan || catatan.trim() === '') {
            alert('Alasan pembatalan wajib diisi!');
            return;
        }

        if (!confirm('Apakah Anda yakin ingin membatalkan bimbingan ini?')) {
            return;
        }

        fetch('/mahasiswa/bimbingan/batalkan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `idBim=${currentIdBim}&catatan=${encodeURIComponent(catatan)}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closePopup('popupBatal');
                    location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat memproses permintaan.');
            });
    }

    document.querySelectorAll('.popup-overlay').forEach(overlay => {
        overlay.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
                currentIdBim = null;
            }
        });
    });
</script>

</body>

</html>